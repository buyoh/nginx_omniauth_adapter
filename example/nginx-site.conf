# vim: ft=nginx
upstream auth_adapter {
  server 127.0.0.1:9292 fail_timeout=0;
}

upstream app {
  server 127.0.0.1:9293 fail_timeout=0;
}

server {
  listen 127.0.0.1:18080;
  server_name ngx-auth.127.0.0.1.xip.io;

  location / {
    proxy_pass http://auth_adapter;
    proxy_set_header Host $host;
  }
}

server {
  listen 127.0.0.1:18080;
  server_name ngx-auth-test.127.0.0.1.xip.io;

  location / {
    auth_request /_auth/challenge;
    # Trick - do internal redirection when auth_request says "need auth". 
    error_page 401 = /_auth/initiate;

    # Receive user info from adapter
    auth_request_set $ngx_oauth_provider $upstream_http_x_ngx_oauth_provider;
    auth_request_set $ngx_oauth_user $upstream_http_x_ngx_oauth_user;
    auth_request_set $ngx_oauth_info $upstream_http_x_ngx_oauth_info;
    proxy_set_header x-ngx-oauth-provider $ngx_oauth_provider;
    proxy_set_header x-ngx-oauth-user $ngx_oauth_user;
    proxy_set_header x-ngx-oauth-info $ngx_oauth_info;

    # pass to backend application as usual as you do.
    proxy_pass http://app;
  }

  # Internal endpoint: test still session is valid (adapter: GET /test)
  location = /_auth/challenge {
    internal;

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Host $host;

    proxy_pass http://auth_adapter/test;
  }

  # Internal endpoint: Initiate authentication. Will redirect to adapter for omniauth sequence. (adapter: GET /initiate)
  location = /_auth/initiate {
    internal;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Host $host;
    proxy_set_header x-ngx-oauth-initiate-back-to http://$host$request_uri;
    proxy_set_header x-ngx-oauth-initiate-callback http://$host/_auth/callback;
    proxy_pass http://auth_adapter/initiate;
  }

  # adapter will back here when authentication succeeded. proxy_pass to adapter to set session cookie.
  location = /_auth/callback {
    auth_request off;

    proxy_set_header Host $host;

    proxy_pass http://auth_adapter/callback;
  }
}
